<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YSD2026 UPM - Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Add Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <style>
        /* Your existing styles - keep them exactly as they are */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #2c3e50, #4a6491);
            color: white;
            padding: 25px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            border-radius: 0 0 10px 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            width: 100%;
            padding: 0 40px;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .logo-text h1 {
            font-size: 2.5rem;
            margin-bottom: 5px;
            font-weight: 700;
        }
        
        .logo-text .event-title {
            font-size: 1.3rem;
            opacity: 0.9;
        }
        
        .admin-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .admin-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .admin-info i {
            font-size: 1.2rem;
        }
        
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
        }
        
        .stat-content h3 {
            font-size: 2.2rem;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        
        .stat-content p {
            color: #666;
            font-size: 0.95rem;
        }
        
        .stat-card:nth-child(1) .stat-icon {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
        }
        
        .stat-card:nth-child(2) .stat-icon {
            background: linear-gradient(135deg, #2196F3, #0D47A1);
        }
        
        .stat-card:nth-child(3) .stat-icon {
            background: linear-gradient(135deg, #FF9800, #EF6C00);
        }
        
        .stat-card:nth-child(4) .stat-icon {
            background: linear-gradient(135deg, #9C27B0, #6A1B9A);
        }
        
        .main-content {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .section-header h2 {
            color: #2c3e50;
            font-size: 1.8rem;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: #4CAF50;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #3d8b40;
        }
        
        .btn-secondary {
            background-color: #2196F3;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #0b7dda;
        }
        
        .btn-danger {
            background-color: #f44336;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #d32f2f;
        }
        
        .btn-warning {
            background-color: #FF9800;
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #EF6C00;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #218838;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
        }
        
        .search-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-group label {
            font-weight: 600;
            color: #444;
            font-size: 0.9rem;
        }
        
        .filter-control {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.95rem;
            min-width: 200px;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }
        
        thead {
            background-color: #f8f9fa;
        }
        
        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #e0e0e0;
            white-space: nowrap;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            vertical-align: top;
        }
        
        tbody tr:hover {
            background-color: #f9f9f9;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-paid {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .status-pending {
            background-color: #fff3e0;
            color: #ef6c00;
        }
        
        .status-cancelled {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .status-present {
            background-color: #d1c4e9;
            color: #512da8;
        }
        
        .ticket-type {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
            background-color: #e3f2fd;
            color: #1565c0;
        }
        
        .participants-list {
            max-height: 120px;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .participant-item {
            padding: 5px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.9rem;
        }
        
        .participant-item:last-child {
            border-bottom: none;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            padding: 20px 30px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            color: #2c3e50;
            font-size: 1.5rem;
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .booking-details {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .detail-group {
            margin-bottom: 20px;
        }
        
        .detail-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #444;
        }
        
        .detail-value {
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }
        
        .readonly-field {
            background-color: #e9ecef;
            cursor: not-allowed;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
            border-top: 1px solid #eee;
            margin-top: 30px;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 30px;
            gap: 10px;
        }
        
        .pagination-btn {
            padding: 8px 15px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .pagination-btn.active {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        .pagination-btn:hover:not(.active) {
            background-color: #e9ecef;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .no-data i {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #ddd;
        }
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .participant-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .participant-row input {
            flex: 1;
        }
        
        .remove-participant {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            width: 30px;
            height: 30px;
            cursor: pointer;
        }
        
        .remove-participant:hover {
            background-color: #c82333;
        }
        
        .add-participant-btn {
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            margin-top: 10px;
            cursor: pointer;
        }
        
        .add-participant-btn:hover {
            background-color: #218838;
        }
        
        .certificate-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 992px) {
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }
            
            .admin-controls {
                flex-direction: column;
                width: 100%;
            }
            
            .admin-info {
                width: 100%;
                justify-content: center;
            }
            
            .search-filter {
                flex-direction: column;
            }
            
            .filter-control {
                min-width: 100%;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header-content {
                padding: 0 20px;
            }
            
            .logo-text h1 {
                font-size: 2rem;
            }
            
            .stat-card {
                flex-direction: column;
                text-align: center;
            }
            
            .modal-content {
                width: 95%;
            }
            
            .booking-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <header>
        <div class="header-content">
            <div class="logo-container">
                <div class="logo-text">
                    <h1>YSD2026 UPM</h1>
                    <div class="event-title">Admin Dashboard</div>
                </div>
            </div>
            
            <div class="admin-controls">
                <div class="admin-info" id="adminInfo">
                    <i class="fas fa-user-shield"></i>
                    <span>Loading...</span>
                </div>
                <button class="btn btn-secondary" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button class="btn btn-danger" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </header>
    
    <div class="container">
        <div class="dashboard-stats">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-ticket-alt"></i>
                </div>
                <div class="stat-content">
                    <h3 id="totalBookings">0</h3>
                    <p>Total Bookings</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-content">
                    <h3 id="totalParticipants">0</h3>
                    <p>Total Participants</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="stat-content">
                    <h3 id="totalRevenue">RM 0.00</h3>
                    <p>Total Revenue</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-award"></i>
                </div>
                <div class="stat-content">
                    <h3 id="certificatesSent">0</h3>
                    <p>Certificates Sent</p>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="section-header">
                <h2><i class="fas fa-list-alt"></i> Booking Management</h2>
                <div class="controls">
                    <button class="btn btn-primary" id="exportCsvBtn">
                        <i class="fas fa-file-csv"></i> Export to CSV
                    </button>
                    <button class="btn btn-secondary" id="addBookingBtn">
                        <i class="fas fa-plus"></i> Add Booking
                    </button>
                </div>
            </div>
            
            <div class="search-filter">
                <div class="filter-group">
                    <label for="searchInput">Search</label>
                    <input type="text" id="searchInput" class="filter-control" placeholder="Search by name, email, reference...">
                </div>
                
                <div class="filter-group">
                    <label for="statusFilter">Status</label>
                    <select id="statusFilter" class="filter-control">
                        <option value="all">All Status</option>
                        <option value="paid">Paid</option>
                        <option value="pending">Pending</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="attendanceFilter">Attendance</label>
                    <select id="attendanceFilter" class="filter-control">
                        <option value="all">All</option>
                        <option value="present">Present</option>
                        <option value="absent">Absent</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="dateFilter">Date Range</label>
                    <select id="dateFilter" class="filter-control">
                        <option value="all">All Dates</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                    </select>
                </div>
            </div>
            
            <div class="table-container">
                <table id="bookingsTable">
                    <thead>
                        <tr>
                            <th>Booking ID</th>
                            <th>Contact Person</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Participants</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Attendance</th>
                            <th>Booking Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="bookingsTableBody">
                        <!-- Bookings will be dynamically added here -->
                    </tbody>
                </table>
                
                <div class="no-data" id="noDataMessage" style="display: none;">
                    <i class="fas fa-clipboard-list"></i>
                    <h3>No bookings found</h3>
                    <p>Try adjusting your search or filter to find what you're looking for.</p>
                </div>
            </div>
            
            <div class="pagination" id="pagination">
                <!-- Pagination will be dynamically added here -->
            </div>
        </div>
        
        <footer>
            <p>YSD2026 Universiti Putra Malaysia Admin Dashboard &copy; 2026. All rights reserved.</p>
            <p>For support, contact: ysd@upm.edu.my </p>
        </footer>
    </div>
    
    <!-- Booking Details Modal -->
    <div class="modal" id="bookingDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Booking Details</h3>
                <button class="close-btn" id="closeModalBtn">&times;</button>
            </div>
            <div class="modal-body" id="bookingDetailsBody">
                <!-- Booking details will be dynamically added here -->
            </div>
        </div>
    </div>
    
    <!-- Edit Booking Modal -->
    <div class="modal" id="editBookingModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Booking</h3>
                <button class="close-btn" id="closeEditModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editBookingForm">
                    <div class="booking-details">
                        <!-- Booking ID - Read Only -->
                        <div class="detail-group" style="grid-column: span 2;">
                            <label>Booking ID (Cannot be changed)</label>
                            <input type="text" id="editBookingId" class="form-control readonly-field" readonly>
                        </div>
                        
                        <div class="detail-group">
                            <label for="editContactPerson">Contact Person *</label>
                            <input type="text" id="editContactPerson" class="form-control" required>
                        </div>
                        
                        <div class="detail-group">
                            <label for="editEmail">Email Address *</label>
                            <input type="email" id="editEmail" class="form-control" required>
                        </div>
                        
                        <div class="detail-group">
                            <label for="editPhone">Phone Number *</label>
                            <input type="tel" id="editPhone" class="form-control" required>
                        </div>
                        
                        <div class="detail-group">
                            <label for="editQuantity">Quantity *</label>
                            <input type="number" id="editQuantity" class="form-control" min="1" max="20" required>
                        </div>
                        
                        <div class="detail-group">
                            <label for="editStatus">Status *</label>
                            <select id="editStatus" class="form-control" required>
                                <option value="pending">Pending</option>
                                <option value="paid">Paid</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        
                        <div class="detail-group">
                            <label for="editAmount">Amount (RM) *</label>
                            <input type="number" id="editAmount" class="form-control" step="0.01" required>
                        </div>
                        
                        <div class="detail-group">
                            <label for="editPaymentMethod">Payment Method</label>
                            <select id="editPaymentMethod" class="form-control">
                                <option value="UPM Gateway">UPM Gateway</option>
                            </select>
                        </div>
                        
                        <div class="detail-group">
                            <label for="editEventDate">Event Date</label>
                            <input type="date" id="editEventDate" class="form-control" value="2026-06-13">
                        </div>
                        
                        <div class="detail-group" style="grid-column: span 2;">
                            <label>Participants (Name & Age only)</label>
                            <div id="editParticipantsContainer">
                                <!-- Participants will be dynamically added here -->
                            </div>
                            <button type="button" class="add-participant-btn" onclick="addEditParticipant()">
                                <i class="fas fa-plus"></i> Add Participant
                            </button>
                        </div>

                        <div class="detail-group" style="grid-column: span 2;">
                            <label>Attendance Tracking</label>
                            <div id="editAttendanceContainer">
                                <!-- Attendance checkboxes will be added here -->
                            </div>
                        </div>
                    </div>
                    
                    <input type="hidden" id="editDocId">
                    
                    <div style="margin-top: 30px; text-align: right;">
                        <button type="button" class="btn btn-secondary" id="cancelEditBtn">Cancel</button>
                        <button type="submit" class="btn btn-success">Update Booking</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Add Booking Modal -->
    <div class="modal" id="addBookingModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Booking</h3>
                <button class="close-btn" id="closeAddModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addBookingForm">
                    <div class="booking-details">
                        <div class="detail-group">
                            <label for="newContactName">Contact Person *</label>
                            <input type="text" id="newContactName" class="form-control" placeholder="Enter full name" required>
                        </div>
                        
                        <div class="detail-group">
                            <label for="newContactEmail">Email Address *</label>
                            <input type="email" id="newContactEmail" class="form-control" placeholder="Enter email address" required>
                        </div>
                        
                        <div class="detail-group">
                            <label for="newContactPhone">Phone Number *</label>
                            <input type="tel" id="newContactPhone" class="form-control" placeholder="Enter phone number" required>
                        </div>
                        
                        <div class="detail-group">
                            <label for="newQuantity">Quantity *</label>
                            <input type="number" id="newQuantity" class="form-control" value="1" min="1" max="20" required>
                        </div>
                        
                        <div class="detail-group">
                            <label for="newStatus">Status *</label>
                            <select id="newStatus" class="form-control" required>
                                <option value="pending">Pending</option>
                                <option value="paid">Paid</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        
                        <div class="detail-group">
                            <label for="newAmount">Amount (RM) *</label>
                            <input type="number" id="newAmount" class="form-control" step="0.01" required>
                        </div>
                        
                        <div class="detail-group" style="grid-column: span 2;">
                            <label for="newParticipants">Participants (One per line, format: Name, Age)</label>
                            <textarea id="newParticipants" class="form-control" rows="4" placeholder="John Doe, 10&#10;Jane Smith, 9"></textarea>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; text-align: right;">
                        <button type="button" class="btn btn-secondary" id="cancelAddBtn">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Booking</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Certificate Modal -->
    <div class="modal" id="certificateModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Generate & Send Certificates</h3>
                <button class="close-btn" id="closeCertificateModalBtn">&times;</button>
            </div>
            <div class="modal-body" id="certificateModalBody">
                <!-- Certificate generation options will be dynamically added -->
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // SECURE FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyABaOMohXrju_OelcUQLAxlIBy809ob3uI",
            authDomain: "ysd2026-upm-tickets-37b0d.firebaseapp.com",
            projectId: "ysd2026-upm-tickets-37b0d",
            storageBucket: "ysd2026-upm-tickets-37b0d.firebasestorage.app",
            messagingSenderId: "1063195509884",
            appId: "1:1063195509884:web:1d9dc8c6723c2382acb5f9"
            // measurementId removed for security
        };

        // Initialize Firebase with error handling
        try {
            firebase.initializeApp(firebaseConfig);
        } catch (error) {
            console.error('Firebase initialization failed:', error);
            alert('System configuration error. Please contact administrator.');
        }
        
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ============================================
        // SECURITY ENHANCEMENTS
        // ============================================
        
        // Session validation
        function validateSession() {
            const adminSession = sessionStorage.getItem('ysd2026_admin');
            const loginTime = sessionStorage.getItem('ysd2026_login_time');
            const csrfToken = sessionStorage.getItem('csrf_token');
            
            if (!adminSession || !loginTime || !csrfToken) {
                return false;
            }
            
            // Check session duration (8 hours max)
            const sessionDuration = Date.now() - parseInt(loginTime);
            if (sessionDuration > 8 * 60 * 60 * 1000) {
                return false;
            }
            
            return true;
        }

        // Input sanitization function
        function sanitizeInput(input) {
            if (!input) return input;
            return input
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#x27;')
                .replace(/\//g, '&#x2F;')
                .replace(/\\/g, '&#x5C;')
                .replace(/`/g, '&#96;');
        }

        // Validate email format
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Validate phone number (Malaysia format)
        function isValidPhone(phone) {
            const phoneRegex = /^(\+?6?01)[0-9]{8,9}$/;
            return phoneRegex.test(phone.replace(/\s/g, ''));
        }

        // Audit log function
        async function createAuditLog(action, details) {
            try {
                const user = auth.currentUser;
                if (!user) return;
                
                await db.collection('audit_logs').add({
                    action: action,
                    details: details,
                    userId: user.uid,
                    userEmail: user.email,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    ip: 'client-side', // Note: Can't get real IP from client
                    userAgent: navigator.userAgent
                });
            } catch (error) {
                console.error('Audit log failed:', error);
            }
        }

        // ============================================
        // CHECK AUTHENTICATION WITH SESSION VALIDATION
        // ============================================
        auth.onAuthStateChanged(async (user) => {
            if (!user || !validateSession()) {
                // Not logged in or invalid session, redirect to login
                sessionStorage.clear();
                window.location.href = 'login.html';
                return;
            }
            
            // Verify user is still admin
            try {
                const adminDoc = await db.collection('admins').doc(user.uid).get();
                if (!adminDoc.exists) {
                    await auth.signOut();
                    sessionStorage.clear();
                    window.location.href = 'login.html';
                    return;
                }
                
                // Log access
                await createAuditLog('DASHBOARD_ACCESS', {
                    timestamp: new Date().toISOString()
                });
                
            } catch (error) {
                console.error('Admin verification failed:', error);
            }
            
            // Update admin info (sanitized)
            const lastLogin = formatDateTime(new Date());
            adminInfo.innerHTML = `
                <i class="fas fa-user-shield"></i>
                <span>${sanitizeInput(user.email)} | Last Login: ${lastLogin}</span>
            `;
            
            // Load bookings
            await loadBookings();
        });

        // ============================================
        // GLOBAL VARIABLES
        // ============================================
        let allBookings = [];
        let filteredBookings = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let currentBookingDetails = null;
        let editParticipants = [];
        let editAttendance = [];

        // ============================================
        // DOM ELEMENTS
        // ============================================
        const loadingOverlay = document.getElementById('loadingOverlay');
        const bookingsTableBody = document.getElementById('bookingsTableBody');
        const noDataMessage = document.getElementById('noDataMessage');
        const totalBookingsElement = document.getElementById('totalBookings');
        const totalParticipantsElement = document.getElementById('totalParticipants');
        const totalRevenueElement = document.getElementById('totalRevenue');
        const certificatesSentElement = document.getElementById('certificatesSent');
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        const attendanceFilter = document.getElementById('attendanceFilter');
        const dateFilter = document.getElementById('dateFilter');
        const bookingDetailsModal = document.getElementById('bookingDetailsModal');
        const editBookingModal = document.getElementById('editBookingModal');
        const addBookingModal = document.getElementById('addBookingModal');
        const certificateModal = document.getElementById('certificateModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const closeEditModalBtn = document.getElementById('closeEditModalBtn');
        const closeAddModalBtn = document.getElementById('closeAddModalBtn');
        const closeCertificateModalBtn = document.getElementById('closeCertificateModalBtn');
        const cancelAddBtn = document.getElementById('cancelAddBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const addBookingBtn = document.getElementById('addBookingBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const addBookingForm = document.getElementById('addBookingForm');
        const editBookingForm = document.getElementById('editBookingForm');
        const newQuantity = document.getElementById('newQuantity');
        const newAmount = document.getElementById('newAmount');
        const adminInfo = document.getElementById('adminInfo');
        const editParticipantsContainer = document.getElementById('editParticipantsContainer');
        const editAttendanceContainer = document.getElementById('editAttendanceContainer');

        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        function showLoading() {
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        function formatDateTime(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            return date.toLocaleDateString('en-US', options);
        }

        function formatDateForInput(date) {
            if (!date) return '';
            const d = date.toDate ? date.toDate() : new Date(date);
            return d.toISOString().split('T')[0];
        }

        // ============================================
        // LOAD BOOKINGS FROM FIRESTORE
        // ============================================
        async function loadBookings() {
            showLoading();
            
            try {
                const snapshot = await db.collection('bookings')
                    .orderBy('bookingDate', 'desc')
                    .get();
                
                allBookings = [];
                snapshot.forEach(doc => {
                    allBookings.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                filteredBookings = [...allBookings];
                currentPage = 1;
                
                renderTable();
                updateStats();
                updatePagination();
                
            } catch (error) {
                console.error('Error loading bookings:', error);
                if (error.code === 'permission-denied') {
                    alert('Access denied. Please contact administrator.');
                    await auth.signOut();
                    sessionStorage.clear();
                    window.location.href = 'login.html';
                } else {
                    alert('Error loading bookings. Please refresh the page.');
                }
            } finally {
                hideLoading();
            }
        }

        // ============================================
        // RENDER TABLE (with sanitized output)
        // ============================================
        function renderTable() {
            bookingsTableBody.innerHTML = '';
            
            if (filteredBookings.length === 0) {
                noDataMessage.style.display = 'block';
                return;
            }
            
            noDataMessage.style.display = 'none';
            
            // Calculate pagination
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredBookings.length);
            const currentBookings = filteredBookings.slice(startIndex, endIndex);
            
            currentBookings.forEach(booking => {
                const row = document.createElement('tr');
                
                // Format participants list with sanitized names
                const participantsList = (booking.participants || []).map(p => 
                    `<div class="participant-item">${sanitizeInput(p.name)} (Age: ${p.age})</div>`
                ).join('');
                
                // Determine status badge class
                let statusClass = 'status-pending';
                if (booking.status === 'paid') statusClass = 'status-paid';
                if (booking.status === 'cancelled') statusClass = 'status-cancelled';
                
                // Calculate attendance count
                const attendanceCount = (booking.attendance || []).filter(a => a.present).length || 0;
                const totalParticipants = booking.quantity || 0;
                const attendanceStatus = attendanceCount === totalParticipants ? 'All Present' : 
                                        attendanceCount > 0 ? `${attendanceCount}/${totalParticipants} Present` : 'None';
                
                row.innerHTML = `
                    <td><strong>${sanitizeInput(booking.bookingId) || 'N/A'}</strong></td>
                    <td>${sanitizeInput(booking.contactPerson) || 'N/A'}</td>
                    <td>${sanitizeInput(booking.email) || 'N/A'}</td>
                    <td>${sanitizeInput(booking.phone) || 'N/A'}</td>
                    <td>
                        <div class="participants-list">
                            ${participantsList || '<em>No participants</em>'}
                        </div>
                        <small>${booking.quantity || 0} participant(s)</small>
                    </td>
                    <td><strong>RM ${(booking.amount || 0).toFixed(2)}</strong></td>
                    <td><span class="status-badge ${statusClass}">${(booking.status || 'pending').toUpperCase()}</span></td>
                    <td><span class="status-badge ${attendanceCount > 0 ? 'status-present' : ''}">${attendanceStatus}</span></td>
                    <td>${formatDate(booking.bookingDate)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-small btn-secondary" onclick="viewBookingDetails('${booking.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-small btn-warning" onclick="openEditBookingModal('${booking.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-small btn-success" onclick="openCertificateModal('${booking.id}')">
                                <i class="fas fa-award"></i>
                            </button>
                            <button class="btn btn-small btn-danger" onclick="deleteBooking('${booking.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                bookingsTableBody.appendChild(row);
            });
        }

        // ============================================
        // UPDATE STATISTICS
        // ============================================
        function updateStats() {
            // Total bookings
            totalBookingsElement.textContent = filteredBookings.length;
            
            // Total participants
            const totalParticipants = filteredBookings.reduce((sum, booking) => sum + (booking.quantity || 0), 0);
            totalParticipantsElement.textContent = totalParticipants;
            
            // Total revenue (only from paid bookings)
            const paidBookings = filteredBookings.filter(b => b.status === 'paid');
            const totalRevenue = paidBookings.reduce((sum, booking) => sum + (booking.amount || 0), 0);
            totalRevenueElement.textContent = `RM ${totalRevenue.toFixed(2)}`;
            
            // Certificates sent
            const certificatesSent = filteredBookings.reduce((sum, booking) => 
                sum + (booking.certificatesSent || 0), 0);
            certificatesSentElement.textContent = certificatesSent;
        }

        // ============================================
        // FILTER BOOKINGS
        // ============================================
        function filterBookings() {
            const searchTerm = searchInput.value.toLowerCase();
            const statusFilterValue = statusFilter.value;
            const attendanceFilterValue = attendanceFilter.value;
            const dateFilterValue = dateFilter.value;
            
            filteredBookings = allBookings.filter(booking => {
                // Search filter (with sanitized comparison)
                const matchesSearch = !searchTerm || 
                    (booking.contactPerson && booking.contactPerson.toLowerCase().includes(searchTerm)) ||
                    (booking.email && booking.email.toLowerCase().includes(searchTerm)) ||
                    (booking.phone && booking.phone.toLowerCase().includes(searchTerm)) ||
                    (booking.bookingId && booking.bookingId.toLowerCase().includes(searchTerm));
                
                // Status filter
                const matchesStatus = statusFilterValue === 'all' || booking.status === statusFilterValue;
                
                // Attendance filter
                let matchesAttendance = true;
                if (attendanceFilterValue !== 'all') {
                    const attendanceCount = (booking.attendance || []).filter(a => a.present).length || 0;
                    if (attendanceFilterValue === 'present') {
                        matchesAttendance = attendanceCount > 0;
                    } else {
                        matchesAttendance = attendanceCount === 0;
                    }
                }
                
                // Date filter
                let matchesDate = true;
                if (dateFilterValue !== 'all' && booking.bookingDate) {
                    const bookingDate = booking.bookingDate.toDate ? booking.bookingDate.toDate() : new Date(booking.bookingDate);
                    const today = new Date();
                    
                    if (dateFilterValue === 'today') {
                        matchesDate = bookingDate.toDateString() === today.toDateString();
                    } else if (dateFilterValue === 'week') {
                        const startOfWeek = new Date(today);
                        startOfWeek.setDate(today.getDate() - today.getDay());
                        matchesDate = bookingDate >= startOfWeek;
                    } else if (dateFilterValue === 'month') {
                        matchesDate = bookingDate.getMonth() === today.getMonth() && 
                                     bookingDate.getFullYear() === today.getFullYear();
                    }
                }
                
                return matchesSearch && matchesStatus && matchesAttendance && matchesDate;
            });
            
            currentPage = 1;
            renderTable();
            updateStats();
            updatePagination();
        }

        // ============================================
        // UPDATE PAGINATION
        // ============================================
        function updatePagination() {
            const paginationElement = document.getElementById('pagination');
            const totalPages = Math.ceil(filteredBookings.length / itemsPerPage);
            
            if (totalPages <= 1) {
                paginationElement.innerHTML = '';
                return;
            }
            
            let paginationHTML = '';
            
            // Previous button
            paginationHTML += `
                <button class="pagination-btn ${currentPage === 1 ? 'disabled' : ''}" 
                        onclick="changePage(${currentPage - 1})" 
                        ${currentPage === 1 ? 'disabled' : ''}>
                    <i class="fas fa-chevron-left"></i>
                </button>
            `;
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    paginationHTML += `
                        <button class="pagination-btn ${i === currentPage ? 'active' : ''}" 
                                onclick="changePage(${i})">
                            ${i}
                        </button>
                    `;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    paginationHTML += `<span class="pagination-btn">...</span>`;
                }
            }
            
            // Next button
            paginationHTML += `
                <button class="pagination-btn ${currentPage === totalPages ? 'disabled' : ''}" 
                        onclick="changePage(${currentPage + 1})" 
                        ${currentPage === totalPages ? 'disabled' : ''}>
                    <i class="fas fa-chevron-right"></i>
                </button>
            `;
            
            paginationElement.innerHTML = paginationHTML;
        }

        // ============================================
        // CHANGE PAGE
        // ============================================
        function changePage(page) {
            if (page < 1 || page > Math.ceil(filteredBookings.length / itemsPerPage)) return;
            
            currentPage = page;
            renderTable();
            window.scrollTo(0, 0);
        }

        // ============================================
        // VIEW BOOKING DETAILS (with sanitized output)
        // ============================================
        async function viewBookingDetails(bookingId) {
            showLoading();
            
            try {
                const doc = await db.collection('bookings').doc(bookingId).get();
                if (!doc.exists) {
                    alert('Booking not found');
                    return;
                }
                
                const booking = { id: doc.id, ...doc.data() };
                currentBookingDetails = booking;
                
                const detailsBody = document.getElementById('bookingDetailsBody');
                
                // Format participants list with sanitized names
                const participantsList = (booking.participants || []).map(p => 
                    `<tr>
                        <td>${sanitizeInput(p.name)}</td>
                        <td>${p.age}</td>
                        <td>${(booking.attendance || []).find(a => a.participantIndex === p.index)?.present ? ' Present' : ' Absent'}</td>
                    </tr>`
                ).join('');
                
                detailsBody.innerHTML = `
                    <div class="booking-details">
                        <div class="detail-group">
                            <label>Booking ID</label>
                            <div class="detail-value">${sanitizeInput(booking.bookingId) || 'N/A'}</div>
                        </div>
                        
                        <div class="detail-group">
                            <label>Contact Person</label>
                            <div class="detail-value">${sanitizeInput(booking.contactPerson) || 'N/A'}</div>
                        </div>
                        
                        <div class="detail-group">
                            <label>Email Address</label>
                            <div class="detail-value">${sanitizeInput(booking.email) || 'N/A'}</div>
                        </div>
                        
                        <div class="detail-group">
                            <label>Phone Number</label>
                            <div class="detail-value">${sanitizeInput(booking.phone) || 'N/A'}</div>
                        </div>
                        
                        <div class="detail-group">
                            <label>Quantity</label>
                            <div class="detail-value">${booking.quantity || 0} ticket(s)</div>
                        </div>
                        
                        <div class="detail-group">
                            <label>Amount</label>
                            <div class="detail-value"><strong>RM ${(booking.amount || 0).toFixed(2)}</strong></div>
                        </div>
                        
                        <div class="detail-group">
                            <label>Status</label>
                            <div class="detail-value">
                                <span class="status-badge ${booking.status === 'paid' ? 'status-paid' : booking.status === 'pending' ? 'status-pending' : 'status-cancelled'}">
                                    ${(booking.status || 'pending').toUpperCase()}
                                </span>
                            </div>
                        </div>
                        
                        <div class="detail-group">
                            <label>Payment Method</label>
                            <div class="detail-value">UPM Gateway</div>
                        </div>
                        
                        <div class="detail-group">
                            <label>Booking Date</label>
                            <div class="detail-value">${formatDateTime(booking.bookingDate)}</div>
                        </div>
                        
                        <div class="detail-group">
                            <label>Certificates Sent</label>
                            <div class="detail-value">${booking.certificatesSent || 0}</div>
                        </div>
                        
                        <div class="detail-group" style="grid-column: span 2;">
                            <label>Participants (${booking.quantity || 0})</label>
                            <div class="detail-value">
                                <table style="width: 100%; margin-top: 10px;">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Age</th>
                                            <th>Attendance</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${participantsList || '<tr><td colspan="3">No participants</td></tr>'}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; text-align: right;">
                        <button class="btn btn-secondary" onclick="document.getElementById('bookingDetailsModal').style.display='none'">Close</button>
                        <button class="btn btn-primary" onclick="printBookingDetails()">
                            <i class="fas fa-print"></i> Print Details
                        </button>
                    </div>
                `;
                
                bookingDetailsModal.style.display = 'flex';
                
                // Log view action
                await createAuditLog('VIEW_BOOKING', { bookingId: booking.bookingId });
                
            } catch (error) {
                console.error('Error loading booking details:', error);
                alert('Error loading booking details');
            } finally {
                hideLoading();
            }
        }

        // ============================================
        // OPEN EDIT BOOKING MODAL (with CSRF check)
        // ============================================
        async function openEditBookingModal(bookingId) {
            // Verify CSRF token
            const csrfToken = sessionStorage.getItem('csrf_token');
            if (!csrfToken) {
                alert('Session invalid. Please login again.');
                window.location.href = 'login.html';
                return;
            }
            
            showLoading();
            
            try {
                const doc = await db.collection('bookings').doc(bookingId).get();
                if (!doc.exists) {
                    alert('Booking not found');
                    return;
                }
                
                const booking = { id: doc.id, ...doc.data() };
                
                // Populate form fields with sanitized values
                document.getElementById('editDocId').value = booking.id;
                document.getElementById('editBookingId').value = sanitizeInput(booking.bookingId) || '';
                document.getElementById('editContactPerson').value = sanitizeInput(booking.contactPerson) || '';
                document.getElementById('editEmail').value = sanitizeInput(booking.email) || '';
                document.getElementById('editPhone').value = sanitizeInput(booking.phone) || '';
                document.getElementById('editQuantity').value = booking.quantity || 1;
                document.getElementById('editStatus').value = booking.status || 'pending';
                document.getElementById('editAmount').value = booking.amount || 0;
                document.getElementById('editPaymentMethod').value = booking.paymentMethod || 'UPM Gateway';
                document.getElementById('editEventDate').value = formatDateForInput(booking.eventDate) || '2026-06-13';
                
                // Set participants with sanitized names
                editParticipants = booking.participants ? booking.participants.map((p, index) => ({
                    ...p,
                    name: sanitizeInput(p.name),
                    index
                })) : [];
                renderEditParticipants();
                
                // Set attendance
                editAttendance = booking.attendance || [];
                renderEditAttendance();
                
                // Show modal
                editBookingModal.style.display = 'flex';
                
            } catch (error) {
                console.error('Error loading booking for edit:', error);
                alert('Error loading booking details');
            } finally {
                hideLoading();
            }
        }

        // ============================================
        // RENDER EDIT PARTICIPANTS (with sanitized output)
        // ============================================
        function renderEditParticipants() {
            editParticipantsContainer.innerHTML = '';
            
            if (editParticipants.length === 0) {
                editParticipantsContainer.innerHTML = '<p class="text-muted">No participants added yet.</p>';
                return;
            }
            
            editParticipants.forEach((participant, index) => {
                const participantDiv = document.createElement('div');
                participantDiv.className = 'participant-row';
                participantDiv.innerHTML = `
                    <input type="text" class="form-control" placeholder="Name" value="${sanitizeInput(participant.name) || ''}" 
                           onchange="updateEditParticipant(${index}, 'name', this.value)">
                    <input type="number" class="form-control" placeholder="Age" min="5" max="12" value="${participant.age || ''}" 
                           onchange="updateEditParticipant(${index}, 'age', this.value)">
                    <button type="button" class="remove-participant" onclick="removeEditParticipant(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                editParticipantsContainer.appendChild(participantDiv);
            });
        }

        // ============================================
        // RENDER EDIT ATTENDANCE (with sanitized output)
        // ============================================
        function renderEditAttendance() {
            editAttendanceContainer.innerHTML = '';
            
            if (editParticipants.length === 0) {
                editAttendanceContainer.innerHTML = '<p class="text-muted">Add participants first to track attendance.</p>';
                return;
            }
            
            const attendanceTitle = document.createElement('p');
            attendanceTitle.innerHTML = '<strong>Mark attendance for each participant:</strong>';
            editAttendanceContainer.appendChild(attendanceTitle);
            
            editParticipants.forEach((participant, index) => {
                const isPresent = editAttendance.find(a => a.participantIndex === index)?.present || false;
                
                const attendanceRow = document.createElement('div');
                attendanceRow.className = 'participant-row';
                attendanceRow.innerHTML = `
                    <span style="min-width: 200px;">${sanitizeInput(participant.name)}</span>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" ${isPresent ? 'checked' : ''} 
                               onchange="updateAttendance(${index}, this.checked)">
                        <span>Present</span>
                    </label>
                `;
                editAttendanceContainer.appendChild(attendanceRow);
            });
        }

        // ============================================
        // UPDATE EDIT PARTICIPANT (with sanitization)
        // ============================================
        function updateEditParticipant(index, field, value) {
            if (!editParticipants[index]) {
                editParticipants[index] = {};
            }
            
            if (field === 'age') {
                value = parseInt(value) || 0;
            }
            
            if (field === 'name') {
                value = sanitizeInput(value);
            }
            
            editParticipants[index][field] = value;
            editParticipants[index].index = index;
        }

        // ============================================
        // ADD EDIT PARTICIPANT
        // ============================================
        function addEditParticipant() {
            const newIndex = editParticipants.length;
            editParticipants.push({ name: '', age: '', index: newIndex });
            renderEditParticipants();
            renderEditAttendance();
        }

        // ============================================
        // REMOVE EDIT PARTICIPANT
        // ============================================
        function removeEditParticipant(index) {
            editParticipants.splice(index, 1);
            editAttendance = editAttendance.filter(a => a.participantIndex !== index);
            // Reindex remaining participants
            editParticipants = editParticipants.map((p, i) => ({...p, index: i}));
            renderEditParticipants();
            renderEditAttendance();
        }

        // ============================================
        // UPDATE ATTENDANCE
        // ============================================
        function updateAttendance(participantIndex, isPresent) {
            const existingIndex = editAttendance.findIndex(a => a.participantIndex === participantIndex);
            if (existingIndex >= 0) {
                if (isPresent) {
                    editAttendance[existingIndex].present = true;
                } else {
                    editAttendance.splice(existingIndex, 1);
                }
            } else if (isPresent) {
                editAttendance.push({ participantIndex, present: true });
            }
        }

        // ============================================
        // UPDATE EDIT BOOKING AMOUNT
        // ============================================
        function updateEditBookingAmount() {
            const quantity = parseInt(document.getElementById('editQuantity').value) || 1;
            const amount = 70 * quantity;
            document.getElementById('editAmount').value = amount.toFixed(2);
        }

        // ============================================
        // SAVE EDIT BOOKING (with validation and audit)
        // ============================================
        async function saveEditBooking(e) {
            e.preventDefault();
            
            // Verify CSRF token
            const csrfToken = sessionStorage.getItem('csrf_token');
            if (!csrfToken) {
                alert('Session invalid. Please login again.');
                window.location.href = 'login.html';
                return;
            }
            
            const docId = document.getElementById('editDocId').value;
            const contactPerson = sanitizeInput(document.getElementById('editContactPerson').value);
            const email = document.getElementById('editEmail').value;
            const phone = sanitizeInput(document.getElementById('editPhone').value);
            const quantity = parseInt(document.getElementById('editQuantity').value);
            const status = document.getElementById('editStatus').value;
            const amount = parseFloat(document.getElementById('editAmount').value);
            const paymentMethod = document.getElementById('editPaymentMethod').value;
            const eventDate = document.getElementById('editEventDate').value;
            
            // Validate email
            if (!isValidEmail(email)) {
                alert('Please enter a valid email address.');
                return;
            }
            
            // Validate phone (optional)
            if (phone && !isValidPhone(phone)) {
                alert('Please enter a valid Malaysian phone number.');
                return;
            }
            
            // Validate participants
            const validParticipants = editParticipants.filter(p => p.name && p.age);
            
            if (validParticipants.length === 0) {
                alert('Please add at least one participant with complete details.');
                return;
            }
            
            if (validParticipants.length !== quantity) {
                alert(`Number of participants (${validParticipants.length}) must match quantity (${quantity}).`);
                return;
            }
            
            // Validate ages
            for (let p of validParticipants) {
                if (p.age < 5 || p.age > 12) {
                    alert(`Participant ${p.name} age must be between 5 and 12.`);
                    return;
                }
            }
            
            showLoading();
            
            try {
                const updateData = {
                    contactPerson: contactPerson,
                    email: email,
                    phone: phone,
                    quantity: quantity,
                    participants: validParticipants,
                    attendance: editAttendance,
                    amount: amount,
                    status: status,
                    paymentMethod: paymentMethod,
                    eventDate: eventDate,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: auth.currentUser ? auth.currentUser.uid : 'unknown'
                };
                
                await db.collection('bookings').doc(docId).update(updateData);
                
                // Create audit log
                await createAuditLog('UPDATE_BOOKING', { 
                    bookingId: document.getElementById('editBookingId').value,
                    changes: updateData 
                });
                
                alert('Booking updated successfully!');
                editBookingModal.style.display = 'none';
                await loadBookings(); // Reload data
                
            } catch (error) {
                console.error('Error updating booking:', error);
                alert('Error updating booking. Please try again.');
            } finally {
                hideLoading();
            }
        }

        // ============================================
        // OPEN CERTIFICATE MODAL (with sanitized output)
        // ============================================
        async function openCertificateModal(bookingId) {
            showLoading();
            
            try {
                const doc = await db.collection('bookings').doc(bookingId).get();
                if (!doc.exists) {
                    alert('Booking not found');
                    return;
                }
                
                const booking = { id: doc.id, ...doc.data() };
                
                const modalBody = document.getElementById('certificateModalBody');
                
                // Get present participants
                const presentParticipants = (booking.participants || []).filter((p, index) => 
                    (booking.attendance || []).some(a => a.participantIndex === index && a.present)
                );
                
                if (presentParticipants.length === 0) {
                    modalBody.innerHTML = `
                        <p>No participants marked as present for this booking.</p>
                        <p>Please mark attendance in the Edit Booking section first.</p>
                        <div style="text-align: right; margin-top: 20px;">
                            <button class="btn btn-secondary" onclick="document.getElementById('certificateModal').style.display='none'">Close</button>
                        </div>
                    `;
                } else {
                    modalBody.innerHTML = `
                        <p><strong>Booking ID:</strong> ${sanitizeInput(booking.bookingId)}</p>
                        <p><strong>Contact:</strong> ${sanitizeInput(booking.contactPerson)}</p>
                        <p><strong>Present Participants:</strong> ${presentParticipants.length} of ${booking.quantity}</p>
                        
                        <div style="margin: 20px 0;">
                            <h4>Participants to receive certificates:</h4>
                            <ul style="list-style: none; padding: 0;">
                                ${presentParticipants.map(p => `
                                    <li style="padding: 8px; border-bottom: 1px solid #eee;">
                                        <i class="fas fa-user" style="color: #4CAF50;"></i> ${sanitizeInput(p.name)} (Age ${p.age})
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        
                        <div class="certificate-controls">
                            <button class="btn btn-primary" onclick="sendCertificates('${booking.id}')">
                                <i class="fas fa-envelope"></i> Send Certificates via Email
                            </button>
                            <button class="btn btn-secondary" onclick="previewCertificates('${booking.id}')">
                                <i class="fas fa-eye"></i> Preview Certificates
                            </button>
                        </div>
                        
                        <div style="text-align: right; margin-top: 20px;">
                            <button class="btn btn-secondary" onclick="document.getElementById('certificateModal').style.display='none'">Close</button>
                        </div>
                    `;
                }
                
                certificateModal.style.display = 'flex';
                
                // Log view action
                await createAuditLog('VIEW_CERTIFICATE_MODAL', { bookingId: booking.bookingId });
                
            } catch (error) {
                console.error('Error opening certificate modal:', error);
                alert('Error loading certificate data');
            } finally {
                hideLoading();
            }
        }

        // ============================================
        // SEND CERTIFICATES (with audit)
        // ============================================
        async function sendCertificates(bookingId) {
            if (!confirm('Send certificates to all present participants? This action cannot be undone.')) {
                return;
            }
            
            showLoading();
            
            try {
                const doc = await db.collection('bookings').doc(bookingId).get();
                if (!doc.exists) {
                    alert('Booking not found');
                    return;
                }
                
                const booking = doc.data();
                
                // Get present participants
                const presentParticipants = (booking.participants || []).filter((p, index) => 
                    (booking.attendance || []).some(a => a.participantIndex === index && a.present)
                );
                
                if (presentParticipants.length === 0) {
                    alert('No present participants to send certificates to.');
                    return;
                }
                
                // Simulate sending emails (in production, this would call a cloud function)
                console.log(`Sending certificates to ${presentParticipants.length} participants at ${booking.email}`);
                
                // Update certificates sent count
                const currentSent = booking.certificatesSent || 0;
                await db.collection('bookings').doc(bookingId).update({
                    certificatesSent: currentSent + presentParticipants.length,
                    certificatesSentAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastCertificateEmail: booking.email,
                    certificatesSentBy: auth.currentUser ? auth.currentUser.uid : 'unknown'
                });
                
                // Create audit log
                await createAuditLog('SEND_CERTIFICATES', { 
                    bookingId: booking.bookingId,
                    count: presentParticipants.length,
                    email: booking.email
                });
                
                alert(`Certificates have been sent to ${presentParticipants.length} participant(s) at ${booking.email}`);
                
                certificateModal.style.display = 'none';
                await loadBookings(); // Reload to update stats
                
            } catch (error) {
                console.error('Error sending certificates:', error);
                alert('Error sending certificates. Please try again.');
            } finally {
                hideLoading();
            }
        }

        // ============================================
        // PREVIEW CERTIFICATES (with sanitized output)
        // ============================================
        async function previewCertificates(bookingId) {
            try {
                const doc = await db.collection('bookings').doc(bookingId).get();
                if (!doc.exists) {
                    alert('Booking not found');
                    return;
                }
                
                const booking = doc.data();
                
                // Get present participants
                const presentParticipants = (booking.participants || []).filter((p, index) => 
                    (booking.attendance || []).some(a => a.participantIndex === index && a.present)
                );
                
                if (presentParticipants.length === 0) {
                    alert('No present participants to preview certificates for.');
                    return;
                }
                
                // Generate certificate preview
                const certificateHTML = generateCertificateHTML(presentParticipants[0], booking);
                
                const printWindow = window.open('', '_blank');
                printWindow.document.write(certificateHTML);
                printWindow.document.close();
                
            } catch (error) {
                console.error('Error previewing certificates:', error);
                alert('Error generating certificate preview');
            }
        }

        // ============================================
        // GENERATE CERTIFICATE HTML (with sanitization)
        // ============================================
        function generateCertificateHTML(participant, booking) {
            const date = new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>YSD2026 Certificate of Participation</title>
                    <style>
                        body {
                            font-family: 'Georgia', serif;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            min-height: 100vh;
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            padding: 20px;
                        }
                        .certificate {
                            background: white;
                            padding: 60px;
                            border-radius: 20px;
                            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                            max-width: 900px;
                            width: 100%;
                            position: relative;
                            overflow: hidden;
                        }
                        .certificate::before {
                            content: '';
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="%23f0f0f0"><path d="M10,10 L90,10 L90,90 L10,90 Z" stroke="%23ddd" fill="none" stroke-width="2"/><circle cx="50" cy="50" r="40" stroke="%23ddd" fill="none" stroke-width="2"/></svg>') repeat;
                            opacity: 0.1;
                            pointer-events: none;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 40px;
                            position: relative;
                        }
                        .header h1 {
                            color: #2c3e50;
                            font-size: 3rem;
                            margin-bottom: 10px;
                            border-bottom: 3px solid #4CAF50;
                            display: inline-block;
                            padding-bottom: 10px;
                        }
                        .content {
                            text-align: center;
                            margin: 40px 0;
                        }
                        .content h2 {
                            color: #666;
                            font-size: 1.8rem;
                            margin-bottom: 20px;
                        }
                        .participant-name {
                            font-size: 3.5rem;
                            color: #2c3e50;
                            margin: 30px 0;
                            font-weight: bold;
                            text-transform: uppercase;
                            letter-spacing: 2px;
                        }
                        .details {
                            background: #f9f9f9;
                            padding: 20px;
                            border-radius: 10px;
                            margin: 30px 0;
                        }
                        .details p {
                            margin: 10px 0;
                            font-size: 1.2rem;
                        }
                        .signature {
                            display: flex;
                            justify-content: space-around;
                            margin-top: 60px;
                        }
                        .signature-line {
                            text-align: center;
                        }
                        .signature-line .line {
                            width: 200px;
                            height: 1px;
                            background: #333;
                            margin-bottom: 10px;
                        }
                        .footer {
                            text-align: center;
                            margin-top: 40px;
                            color: #666;
                            font-size: 0.9rem;
                        }
                        .medal {
                            font-size: 4rem;
                            color: #ffd700;
                            margin: 20px 0;
                        }
                        @media print {
                            body { background: white; }
                            .certificate { box-shadow: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="certificate">
                        <div class="header">
                            <h1>YOUTH SPORTS DAY 2026</h1>
                            <p>Universiti Putra Malaysia</p>
                        </div>
                        
                        <div class="content">
                            <div class="medal"></div>
                            <h2>CERTIFICATE OF PARTICIPATION</h2>
                            <p>This certificate is proudly presented to</p>
                            <div class="participant-name">${sanitizeInput(participant.name)}</div>
                            <p>for active participation in</p>
                            <p style="font-size: 1.5rem; color: #4CAF50;">YSD2026 UPM Youth Sports Day</p>
                            <p>held on 13th June 2026</p>
                            
                            <div class="details">
                                <p><strong>Age Group:</strong> ${participant.age} years</p>
                                <p><strong>Event:</strong> Youth Sports Day 2026</p>
                                <p><strong>Venue:</strong> Universiti Putra Malaysia, Serdang</p>
                                <p><strong>Date:</strong> 13th June 2026</p>
                            </div>
                        </div>
                        
                        <div class="signature">
                            <div class="signature-line">
                                <div class="line"></div>
                                <p>Prof. Datin Paduka Dr. Aini Ideris</p>
                                <p>Vice-Chancellor, UPM</p>
                            </div>
                            <div class="signature-line">
                                <div class="line"></div>
                                <p>Dr. Ahmad Faizal</p>
                                <p>Event Director, YSD2026</p>
                            </div>
                        </div>
                        
                        <div class="footer">
                            <p>Certificate ID: YSD2026-${participant.name.replace(/\s+/g, '')}-${Date.now()}</p>
                            <p>Issued on: ${date}</p>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;" class="no-print">
                        <button onclick="window.print()">Print Certificate</button>
                        <button onclick="window.close()">Close</button>
                    </div>
                </body>
                </html>
            `;
        }

        // ============================================
        // PRINT BOOKING DETAILS (with sanitized output)
        // ============================================
        function printBookingDetails() {
            if (!currentBookingDetails) return;
            
            const booking = currentBookingDetails;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Booking Details - ${booking.bookingId}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
                        .header h1 { color: #2c3e50; margin-bottom: 5px; }
                        .info { margin-bottom: 20px; }
                        .info-row { display: flex; margin-bottom: 10px; }
                        .label { font-weight: bold; width: 200px; }
                        .participants-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        .participants-table th, .participants-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                        .participants-table th { background-color: #f5f5f5; }
                        .footer { text-align: center; margin-top: 40px; font-size: 0.9rem; color: #666; border-top: 1px solid #ddd; padding-top: 20px; }
                        @media print {
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>YOUTH SPORTS DAY 2026</h1>
                        <h2>Booking Details</h2>
                        <p>Generated on: ${new Date().toLocaleDateString()}</p>
                    </div>
                    
                    <div class="info">
                        <div class="info-row">
                            <div class="label">Booking ID:</div>
                            <div>${sanitizeInput(booking.bookingId) || 'N/A'}</div>
                        </div>
                        <div class="info-row">
                            <div class="label">Contact Person:</div>
                            <div>${sanitizeInput(booking.contactPerson) || 'N/A'}</div>
                        </div>
                        <div class="info-row">
                            <div class="label">Email:</div>
                            <div>${sanitizeInput(booking.email) || 'N/A'}</div>
                        </div>
                        <div class="info-row">
                            <div class="label">Phone:</div>
                            <div>${sanitizeInput(booking.phone) || 'N/A'}</div>
                        </div>
                        <div class="info-row">
                            <div class="label">Quantity:</div>
                            <div>${booking.quantity || 0}</div>
                        </div>
                        <div class="info-row">
                            <div class="label">Amount:</div>
                            <div><strong>RM ${(booking.amount || 0).toFixed(2)}</strong></div>
                        </div>
                        <div class="info-row">
                            <div class="label">Status:</div>
                            <div>${(booking.status || 'pending').toUpperCase()}</div>
                        </div>
                        <div class="info-row">
                            <div class="label">Booking Date:</div>
                            <div>${formatDateTime(booking.bookingDate)}</div>
                        </div>
                    </div>
                    
                    <h3>Participants (${booking.quantity || 0})</h3>
                    <table class="participants-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Name</th>
                                <th>Age</th>
                                <th>Attendance</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${(booking.participants || []).map((p, i) => `
                                <tr>
                                    <td>${i + 1}</td>
                                    <td>${sanitizeInput(p.name)}</td>
                                    <td>${p.age}</td>
                                    <td>${(booking.attendance || []).find(a => a.participantIndex === i)?.present ? 'Present' : 'Absent'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p>YSD2026 Universiti Putra Malaysia</p>
                        <p>For inquiries: admin.ysd2026@upm.edu.my | +603-9769 5678</p>
                    </div>
                    
                    <div class="no-print" style="text-align: center; margin-top: 20px;">
                        <button onclick="window.print()">Print</button>
                        <button onclick="window.close()">Close</button>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // ============================================
        // DELETE BOOKING (with audit)
        // ============================================
        async function deleteBooking(bookingId) {
            if (!confirm('Are you sure you want to delete this booking? This action cannot be undone.')) {
                return;
            }
            
            showLoading();
            
            try {
                // Get booking data for audit before deletion
                const bookingDoc = await db.collection('bookings').doc(bookingId).get();
                const bookingData = bookingDoc.data();
                
                // Create audit log
                await createAuditLog('DELETE_BOOKING', { 
                    bookingId: bookingData.bookingId,
                    bookingData: bookingData 
                });
                
                await db.collection('bookings').doc(bookingId).delete();
                alert('Booking deleted successfully!');
                await loadBookings(); // Reload data
                
            } catch (error) {
                console.error('Error deleting booking:', error);
                alert('Error deleting booking. Please try again.');
            } finally {
                hideLoading();
            }
        }

        // ============================================
        // ADD NEW BOOKING (with validation and audit)
        // ============================================
        async function addNewBooking(e) {
            e.preventDefault();
            
            // Verify CSRF token
            const csrfToken = sessionStorage.getItem('csrf_token');
            if (!csrfToken) {
                alert('Session invalid. Please login again.');
                window.location.href = 'login.html';
                return;
            }
            
            // Get form values and sanitize
            const contactName = sanitizeInput(document.getElementById('newContactName').value);
            const email = document.getElementById('newContactEmail').value;
            const phone = sanitizeInput(document.getElementById('newContactPhone').value);
            const quantity = parseInt(document.getElementById('newQuantity').value);
            const status = document.getElementById('newStatus').value;
            const amount = parseFloat(document.getElementById('newAmount').value);
            const participantsText = document.getElementById('newParticipants').value;
            
            // Validate email
            if (!isValidEmail(email)) {
                alert('Please enter a valid email address.');
                return;
            }
            
            // Validate phone (optional)
            if (phone && !isValidPhone(phone)) {
                alert('Please enter a valid Malaysian phone number.');
                return;
            }
            
            // Parse participants (Name, Age) with sanitization
            const participants = [];
            if (participantsText.trim()) {
                const lines = participantsText.split('\n');
                for (let i = 0; i < lines.length; i++) {
                    const parts = lines[i].split(',').map(part => part.trim());
                    if (parts.length >= 2) {
                        const age = parseInt(parts[1]);
                        if (age < 5 || age > 12) {
                            alert(`Participant ${parts[0]} age must be between 5 and 12.`);
                            return;
                        }
                        participants.push({
                            name: sanitizeInput(parts[0]),
                            age: age,
                            index: i
                        });
                    }
                }
            }
            
            if (participants.length === 0) {
                alert('Please add at least one participant.');
                return;
            }
            
            if (participants.length !== quantity) {
                alert(`Number of participants (${participants.length}) must match quantity (${quantity}).`);
                return;
            }
            
            // Generate booking ID
            const bookingId = 'YSD-' + new Date().getFullYear() + '-' + Math.floor(1000 + Math.random() * 9000);
            
            showLoading();
            
            try {
                // Create booking data
                const bookingData = {
                    bookingId: bookingId,
                    contactPerson: contactName,
                    email: email,
                    phone: phone,
                    quantity: quantity,
                    participants: participants,
                    amount: amount,
                    status: status,
                    paymentMethod: 'UPM Gateway',
                    bookingDate: firebase.firestore.FieldValue.serverTimestamp(),
                    eventDate: '2026-06-13',
                    attendance: [],
                    certificatesSent: 0,
                    createdBy: auth.currentUser ? auth.currentUser.uid : 'unknown'
                };
                
                // Save to Firestore
                await db.collection('bookings').add(bookingData);
                
                // Create audit log
                await createAuditLog('CREATE_BOOKING', { 
                    bookingId: bookingId,
                    bookingData: bookingData 
                });
                
                // Reset form
                addBookingForm.reset();
                newAmount.value = (70 * quantity).toFixed(2);
                newQuantity.value = '1';
                
                // Close modal
                addBookingModal.style.display = 'none';
                
                // Refresh dashboard
                await loadBookings();
                
                alert(`New booking ${bookingId} has been added successfully!`);
                
            } catch (error) {
                console.error('Error adding booking:', error);
                alert('Error adding booking. Please try again.');
            } finally {
                hideLoading();
            }
        }

        // ============================================
        // UPDATE AMOUNT IN ADD BOOKING FORM
        // ============================================
        function updateNewBookingAmount() {
            const quantity = parseInt(newQuantity.value) || 1;
            const amount = 70 * quantity;
            newAmount.value = amount.toFixed(2);
        }

        // ============================================
        // EXPORT TO CSV (with audit)
        // ============================================
        function exportToCSV() {
            if (filteredBookings.length === 0) {
                alert('No data to export');
                return;
            }
            
            // Prepare data for CSV
            const csvData = [];
            
            // Add headers
            csvData.push([
                'Booking ID',
                'Contact Person',
                'Email',
                'Phone',
                'Quantity',
                'Amount (RM)',
                'Status',
                'Booking Date',
                'Payment Method',
                'Participants Count',
                'Present Count',
                'Certificates Sent'
            ]);
            
            // Add booking data (with sanitization)
            filteredBookings.forEach(booking => {
                const presentCount = (booking.attendance || []).filter(a => a.present).length;
                csvData.push([
                    booking.bookingId || 'N/A',
                    booking.contactPerson || 'N/A',
                    booking.email || 'N/A',
                    booking.phone || 'N/A',
                    booking.quantity || 0,
                    (booking.amount || 0).toFixed(2),
                    booking.status || 'pending',
                    booking.bookingDate ? formatDate(booking.bookingDate) : 'N/A',
                    'UPM Gateway',
                    booking.quantity || 0,
                    presentCount,
                    booking.certificatesSent || 0
                ]);
            });
            
            // Convert to CSV string
            const csvContent = csvData.map(row => 
                row.map(cell => `"${cell}"`).join(',')
            ).join('\n');
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `YSD2026_Bookings_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Log export for audit
            createAuditLog('EXPORT_CSV', {
                recordCount: filteredBookings.length,
                filename: `YSD2026_Bookings_${new Date().toISOString().slice(0,10)}.csv`
            });
            
            alert(`CSV file with ${filteredBookings.length} bookings has been downloaded.`);
        }

        // ============================================
        // REFRESH DASHBOARD
        // ============================================
        async function refreshDashboard() {
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
            await loadBookings();
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
        }

        // ============================================
        // LOGOUT (with audit)
        // ============================================
        async function logoutAdmin() {
            if (!confirm('Are you sure you want to logout?')) return;
            
            showLoading();
            
            try {
                // Log logout
                await createAuditLog('LOGOUT', {});
                
                await auth.signOut();
                sessionStorage.clear();
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Logout error:', error);
                hideLoading();
                alert('Error logging out. Please try again.');
            }
        }

        // ============================================
        // AUTO-REFRESH SESSION CHECK
        // ============================================
        setInterval(() => {
            const loginTime = sessionStorage.getItem('ysd2026_login_time');
            if (loginTime) {
                const sessionDuration = Date.now() - parseInt(loginTime);
                if (sessionDuration > 7 * 60 * 60 * 1000) { // 7 hours
                    alert('Your session will expire in 1 hour. Please save your work.');
                }
            }
        }, 30 * 60 * 1000); // Check every 30 minutes

        // ============================================
        // EVENT LISTENERS
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            // Search and filter events
            searchInput.addEventListener('input', filterBookings);
            statusFilter.addEventListener('change', filterBookings);
            attendanceFilter.addEventListener('change', filterBookings);
            dateFilter.addEventListener('change', filterBookings);
            
            // Modal close events
            closeModalBtn.addEventListener('click', () => bookingDetailsModal.style.display = 'none');
            closeEditModalBtn.addEventListener('click', () => editBookingModal.style.display = 'none');
            closeAddModalBtn.addEventListener('click', () => addBookingModal.style.display = 'none');
            closeCertificateModalBtn.addEventListener('click', () => certificateModal.style.display = 'none');
            cancelAddBtn.addEventListener('click', () => addBookingModal.style.display = 'none');
            cancelEditBtn.addEventListener('click', () => editBookingModal.style.display = 'none');
            
            // Close modal when clicking outside
            window.addEventListener('click', (event) => {
                if (event.target === bookingDetailsModal) {
                    bookingDetailsModal.style.display = 'none';
                }
                if (event.target === editBookingModal) {
                    editBookingModal.style.display = 'none';
                }
                if (event.target === addBookingModal) {
                    addBookingModal.style.display = 'none';
                }
                if (event.target === certificateModal) {
                    certificateModal.style.display = 'none';
                }
            });
            
            // Button events
            refreshBtn.addEventListener('click', refreshDashboard);
            exportCsvBtn.addEventListener('click', exportToCSV);
            addBookingBtn.addEventListener('click', () => addBookingModal.style.display = 'flex');
            logoutBtn.addEventListener('click', logoutAdmin);
            
            // Form events
            addBookingForm.addEventListener('submit', addNewBooking);
            editBookingForm.addEventListener('submit', saveEditBooking);
            
            // Quantity change events
            newQuantity.addEventListener('change', updateNewBookingAmount);
            document.getElementById('editQuantity').addEventListener('change', updateEditBookingAmount);
            
            // Add CSRF token to forms
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = sessionStorage.getItem('csrf_token') || '';
            addBookingForm.appendChild(csrfInput.cloneNode(true));
            editBookingForm.appendChild(csrfInput.cloneNode(true));
        });

        // Make functions globally available
        window.changePage = changePage;
        window.viewBookingDetails = viewBookingDetails;
        window.openEditBookingModal = openEditBookingModal;
        window.deleteBooking = deleteBooking;
        window.printBookingDetails = printBookingDetails;
        window.addEditParticipant = addEditParticipant;
        window.removeEditParticipant = removeEditParticipant;
        window.updateEditParticipant = updateEditParticipant;
        window.updateAttendance = updateAttendance;
        window.openCertificateModal = openCertificateModal;
        window.sendCertificates = sendCertificates;
        window.previewCertificates = previewCertificates;
    </script>
</body>
</html>




